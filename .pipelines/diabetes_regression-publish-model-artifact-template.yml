steps:
  # Install Azure ML CLI v2
  - task: AzureCLI@2
    displayName: "Install Azure ML CLI (v2)"
    inputs:
      azureSubscription: "$(WORKSPACE_SVC_CONNECTION)"
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e
        az extension add -n ml -y
        az extension list -o table

  # Check if model registered
  - task: AzureCLI@2
    name: getversion
    displayName: "Determine if evaluation succeeded and new model is registered"
    inputs:
      azureSubscription: "$(WORKSPACE_SVC_CONNECTION)"
      scriptType: bash
      scriptLocation: inlineScript
      workingDirectory: $(Build.SourcesDirectory)
      inlineScript: |
        set -e

        echo "Checking for model with BuildId=$(Build.BuildId)..."

        FOUND_MODEL=$(az ml model list \
          --resource-group $(RESOURCE_GROUP) \
          --workspace-name $(WORKSPACE_NAME) \
          --query "[?tags.BuildId=='$(Build.BuildId)'] | [0]" \
          -o json)

        if [ "$FOUND_MODEL" == "null" ] || [ -z "$FOUND_MODEL" ]; then
          echo "Model was not registered for this run."
          exit 1
        fi

        echo "$FOUND_MODEL" > model.json
        echo "Model found and saved to model.json"

  # Publish artifact
  - publish: model.json
    artifact: model
